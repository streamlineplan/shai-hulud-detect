# Shai-Hulud NPM Supply Chain Attack Detector - Docker Compose
#
# SETUP: Add your project paths in the volumes section below
#
# USAGE:
# Normal scan:    docker compose up
# Paranoid scan:  PARANOID=true docker compose up
#
# RESULTS:
# Reports will be saved in ./reports/ directory
# Clean projects show: "âœ… project-name - CLEAN"
# Issues found show:   "ðŸ”´ project-name - ISSUES FOUND"

services:
  shai-hulud-scanner:
    image: bash:5.3.3-alpine3.22
    container_name: shai-hulud-scanner
    working_dir: /scanner
    environment:
      - PARANOID=${PARANOID:-false}
    volumes:
      - ./shai-hulud-detector.sh:/scanner/shai-hulud-detector.sh
      - ./compromised-packages.txt:/scanner/compromised-packages.txt:ro

      - ./reports:/reports
      
      # Add your project paths here:
      # - /path/to/your/project1:/projects/project1:ro
      # - /path/to/your/project2:/projects/project2:ro
    
    command: |
      sh -c "
        mkdir -p /reports
        
        if [ \"$$PARANOID\" = \"true\" ]; then
          echo \"ðŸ”ðŸ” Running PARANOID scan\"
          SCAN_FLAG=\"--paranoid\"
        else
          echo \"ðŸ” Running NORMAL scan\"
          SCAN_FLAG=\"\"
        fi
        
        for project in /projects/*; do
          if [ -d \"$$project\" ]; then
            name=$$(basename \"$$project\")
            echo \"Scanning: $$name\"
            bash /scanner/shai-hulud-detector.sh $$SCAN_FLAG \"$$project\" 2>&1 | sed 's/\x1b\[[0-9;]*m//g' > \"/reports/$${name}_report.txt\"
            
            if grep -q 'No indicators of Shai-Hulud compromise detected' \"/reports/$${name}_report.txt\"; then
              echo \"âœ… $$name - CLEAN\"
            else
              echo \"ðŸ”´ $$name - ISSUES FOUND\"
            fi
          fi
        done
        
        echo \"Reports saved to ./reports/\"
      "
    
    restart: "no"